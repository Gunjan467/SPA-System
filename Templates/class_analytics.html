{% extends 'base.html' %}
{% block content %}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
.analytics-page{
    padding-top:70px;
    width:100%;
    display:flex;
    justify-content:center;
}

.analytics-card{
    background:#fff;
    border-radius:20px;
    padding:28px 36px;

    width:88vw;
    max-width:1250px;
    min-width:1000px;

    margin:30px auto;
    box-shadow:0 12px 35px rgba(0,0,0,0.08);
}

.analytics-grid{
    display:grid;
    grid-template-columns:repeat(3,1fr);
    gap:20px;
    margin-bottom:35px;
}

.analytics-box{
    background:#f8fafc;
    border-radius:16px;
    padding:20px;
    text-align:center;
}

.analytics-box h2{
    font-size:34px;
    color:#2563eb;
    margin:0;
}

/* ‚úÖ FIXED CHART CONTAINERS */
.chart-box{
    margin:35px 0;
    height:340px;              /* ‚¨Ö slightly taller */
}

.subject-chart-box{
    height:380px;              /* ‚¨Ö ensures subject chart renders */
}

.chart-box canvas{
    width:100% !important;
    height:100% !important;
}

.semester-filter{
    margin-bottom:25px;
}

.risk-box{
    background:#fff7ed;
    border-radius:16px;
    padding:18px;
    color:#9a3412;
}

.back-btn{
    display:inline-block;
    margin-top:25px;
    background:#4b5563;
    color:#fff;
    padding:10px 20px;
    border-radius:22px;
    text-decoration:none;
}
</style>

<div class="analytics-page">
<div class="analytics-card">

<h3>üìä Class Analytics</h3>

<!-- SEMESTER FILTER -->
<div class="semester-filter">
    <strong>Semester:</strong>
    <select onchange="location.href='?semester='+this.value">
        <option value="All" {{ 'selected' if semester=='All' }}>All</option>
        <option value="1" {{ 'selected' if semester=='1' }}>Sem 1</option>
        <option value="2" {{ 'selected' if semester=='2' }}>Sem 2</option>
    </select>
</div>

<!-- OVERVIEW -->
<div class="analytics-grid">
    <div class="analytics-box">
        <h2>{{ avg_gpa }}</h2>
        <p>Average GPA</p>
    </div>

    <div class="analytics-box">
        <h2>{{ highest.gpa }}</h2>
        <p>Highest GPA</p>
        <small>üèÜ {{ highest.username }}</small>
    </div>

    <div class="analytics-box">
        <h2>{{ lowest.gpa }}</h2>
        <p>Lowest GPA</p>
        <small>‚ö† {{ lowest.username }}</small>
    </div>
</div>

<!-- GPA DISTRIBUTION -->
<div class="chart-box">
    <h4>GPA Distribution</h4>
    <canvas id="gpaChart"></canvas>
</div>

<!-- SUBJECT PERFORMANCE -->
<div class="chart-box subject-chart-box">
    <h4>Subject-wise Performance</h4>
    <canvas id="subjectChart"></canvas>
</div>

<!-- RISK SUMMARY -->
<div class="risk-box">
    <strong>‚ö† Students Needing Attention</strong>
    <ul>
        <li>{{ low_gpa_count }} students have GPA below 6</li>
        <li>{{ failed_students }} students failed in at least one subject</li>
    </ul>
</div>

<a href="/teacher-dashboard" class="back-btn">‚Üê Back to Dashboard</a>

</div>
</div>
<script>
document.addEventListener("DOMContentLoaded", function () {

    /* GPA DISTRIBUTION (already working) */
    new Chart(document.getElementById("gpaChart"), {
        type: "bar",
        data: {
            labels: {{ dist.keys() | list | tojson }},
            datasets: [{
                data: {{ dist.values() | list | tojson }},
                backgroundColor: "#60a5fa",
                barThickness: 55,
                maxBarThickness: 65
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                y: { beginAtZero: true, ticks: { stepSize: 1 } }
            }
        }
    });


    /* ‚úÖ SUBJECT-WISE PERFORMANCE (FIXED) */
    new Chart(document.getElementById("subjectChart"), {
        type: "bar",
        data: {
            labels: {{ subject_labels | tojson }},
            datasets: [{
                data: {{ subject_values | tojson }},
                backgroundColor: "#34d399",
                barThickness: 60,
                maxBarThickness: 70
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 10,
                    ticks: { stepSize: 1 }
                }
            }
        }
    });

});
</script>

{% endblock %}
