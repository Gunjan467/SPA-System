{% extends 'base.html' %}

{% block content %}
<style>
/* ===== PAGE WRAPPER ===== */
.teacher-page {
    background: linear-gradient(135deg, #eef2ff, #fdf2f8);
    min-height: 100vh;
    padding: 30px;
}

.marks-wrapper {
    max-width: 1200px;
    margin: auto;
}

/* ===== CARDS ===== */
.marks-card {
    background: white;
    border-radius: 16px;
    padding: 22px;
    margin-bottom: 22px;
    box-shadow: 0 12px 30px rgba(0,0,0,0.08);
}
.add-card { background:#f0fdf4; }
.update-card { background:#fff7ed; }
.filter-card { background:#eff6ff; }

/* ===== TITLES ===== */
.card-title {
    font-size: 18px;
    font-weight: 700;
    margin-bottom: 14px;
}

/* ===== FORMS ===== */
.form-row {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
}

input, select {
    padding: 10px 14px;
    border-radius: 10px;
    border: 1px solid #d1d5db;
    min-width: 180px;
    font-size: 14px;
}

/* ===== BUTTONS ===== */
.add-btn {
    background: #22c55e;
    color: white;
    border: none;
    padding: 10px 18px;
    border-radius: 10px;
    font-weight: 600;
    cursor: pointer;
}
.add-btn:hover { background:#16a34a; }

.update-btn {
    background: #fb923c;
    color: white;
    border: none;
    padding: 10px 18px;
    border-radius: 10px;
    font-weight: 600;
    cursor: pointer;
}
.update-btn:hover { background:#f97316; }

.filter-btn {
    background: #3b82f6;
    color: white;
    border: none;
    padding: 10px 18px;
    border-radius: 10px;
    font-weight: 600;
    cursor: pointer;
}
.filter-btn:hover { background:#2563eb; }
.inline-update {
    background-color: #fb923c;
    color: #ffffff;
    border: none;
    padding: 8px 18px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    white-space: nowrap;
    display: inline-block;
    min-width: 90px;
}

.inline-update:hover {
    background-color: #f97316;
}

.delete-btn {
    background: #fee2e2;
    color: #b91c1c;
    border: none;
    padding: 6px 14px;
    border-radius: 8px;
    cursor: pointer;
}
.delete-btn:hover { background:#fecaca; }

/* ===== TABLE ===== */
table {
    width: 100%;
    border-collapse: collapse;
    table-layout: fixed;
}

thead th {
    background: #f3f4f6;
    font-weight: 700;
    padding: 14px;
    text-align: center;
}

tbody td {
    padding: 14px;
    text-align: center;
    vertical-align: middle;
}

/* LEFT align ONLY Name & Subject (both th and td) */
thead th:nth-child(2),
thead th:nth-child(3),
tbody td:nth-child(2),
tbody td:nth-child(3) {
    text-align: left;
}

.flash-msg.success {
    background:#dcfce7;
    color:#166534;
    padding:10px;
    border-radius:10px;
    margin-bottom:15px;
}
.flash-msg.error {
    background:#fee2e2;
    color:#991b1b;
    padding:10px;
    border-radius:10px;
    margin-bottom:15px;
}
<style>
.percent-low {
    color: #dc2626;
    font-weight: 700;
}

.percent-mid {
    color: #f97316;
    font-weight: 700;
}

.percent-high {
    color: #16a34a;
    font-weight: 700;
}
</style>

</style>

<div class="teacher-page">
<div class="marks-wrapper">

{% with messages = get_flashed_messages(with_categories=true) %}
{% for c,m in messages %}
<div class="flash-msg {{ c }}">{{ m }}</div>
{% endfor %}
{% endwith %}

<!-- ADD -->
<div class="marks-card add-card">
    <div class="card-title">‚ûï Add Attendance</div>
    <form method="POST" class="form-row">
        <input type="hidden" name="mode" value="add">

        <input type="number" name="roll_no" placeholder="Roll No" required>
        <input type="text" name="subject" placeholder="Subject" required>
        <input type="number" name="total_classes" placeholder="Total Classes" required>
        <input type="number" name="attended_classes" placeholder="Attended" required>

        <button class="add-btn">Add</button>
    </form>
</div>

<div class="marks-card update-card">
    <div class="card-title">‚úèÔ∏è Update Attendance</div>
    <form method="POST" class="form-row">

        <select onchange="autoFillFromSelect(this)">
            <option value="">Select Record</option>
            {% for a in attendance %}
            <option value="{{ a[0] }}|{{ a[4] }}|{{ a[5] }}">
                Roll {{ a[1] }} - {{ a[3] }}
            </option>
            {% endfor %}
        </select>

        <input type="hidden" name="mode" value="update">
        <input type="hidden" name="record_id" id="record_id">

        <input type="number" id="total" name="total_classes" placeholder="Total Classes" required>
        <input type="number" id="attended" name="attended_classes" placeholder="Attended" required>

        <button class="update-btn">Update</button>
    </form>
</div>

<!-- FILTER -->
<div class="marks-card filter-card">
    <div class="card-title">üîç Filter Attendance</div>
    <form method="GET" class="form-row">
        <input type="text" name="search" placeholder="Roll No or Name">
        <input type="text" name="subject" placeholder="Subject">
        <button class="filter-btn">Filter</button>
    </form>
</div>

<div class="marks-card">
    <div class="card-title">üìä Overall Attendance</div>

    <table>
        <thead>
            <tr>
                <th>Roll No</th>
                <th>Name</th>
                <th>Total Classes</th>
                <th>Attended</th>
                <th>Overall %</th>
            </tr>
        </thead>
        <tbody>
            {% for o in overall_attendance %}
            <tr>
                <td>{{ o[0] }}</td>
                <td>{{ o[1] }}</td>
                <td>{{ o[2] }}</td>
                <td>{{ o[3] }}</td>
                <td>
                    <span class="
                        {% if o[4] < 75 %}
                            percent-low
                        {% elif o[4] < 85 %}
                            percent-mid
                        {% else %}
                            percent-high
                        {% endif %}
                    ">
                        {{ o[4] }}%
                    </span>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- TABLE -->
<div class="marks-card">
<div class="card-title">üìã Attendance Records</div>

<table>
<thead>
<tr>
    <th>Roll No</th>
    <th>Name</th>
    <th>Subject</th>
    <th>Total</th>
    <th>Attended</th>
    <th>%</th>
    <th>Update</th>
    <th>Remove</th>
</tr>
</thead>

<tbody>
{% for a in attendance %}
<tr>
    <td>{{ a[1] }}</td>
    <td>{{ a[2] }}</td>
    <td>{{ a[3] }}</td>
    <td>{{ a[4] }}</td>
    <td>{{ a[5] }}</td>
    <td>
    <span class="
        {% if a[6] < 75 %}
            percent-low
        {% elif a[6] < 85 %}
            percent-mid
        {% else %}
            percent-high
        {% endif %}
    ">
        {{ a[6] }}%
    </span>
</td>

    <td>
        <button type="button" class="inline-update"
    onclick="fillAttendance('{{ a[0] }}','{{ a[4] }}','{{ a[5] }}')">
    Update
</button>
    </td>
    <td>
        <form method="POST">
            <input type="hidden" name="mode" value="delete">
            <input type="hidden" name="record_id" value="{{ a[0] }}">
            <button class="delete-btn"
onclick="return confirm('Are you sure you want to delete this attendance record?');">
Delete
</button>

        </form>
    </td>
</tr>
{% endfor %}
</tbody>
</table>

<a href="/teacher-dashboard" class="btn btn-secondary mt-3">
‚Üê Back to Dashboard
</a>

</div>
</div>
</div>
<script>
function fillAttendance(id, total, attended) {
    document.getElementById('record_id').value = id;
    document.getElementById('total').value = total;
    document.getElementById('attended').value = attended;

    let select = document.querySelector("select");
    for (let i = 0; i < select.options.length; i++) {
        if (select.options[i].value.startsWith(id + "|")) {
            select.selectedIndex = i;
            break;
        }
    }

    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function autoFillFromSelect(sel) {
    if (!sel.value) return;
    let data = sel.value.split('|');
    fillAttendance(data[0], data[1], data[2]);
}
</script>

{% endblock %}
